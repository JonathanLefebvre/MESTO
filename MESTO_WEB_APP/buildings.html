<!DOCTYPE html>
<html>
<head>
  <title>Manage Buildings</title>
  <script src="libs/angular.min.js"></script>

<style>
/* In IE vs Chrome, the column of textarea is different */
form {
	border:1px solid black;
	width:695px; 
	height:300px;
}

.section, .section2 {
    display: block;
    width: 330px;
	/*border: 1px solid red;*/
	padding: 4px;
}
.section2 {
    position: relative;
	top: -301px;
	left: 339px;
}

.field, .fieldgrp {
    display: block;
    padding: 4px 4px;
} 
.field label {
	padding-right: 5px;
}
.field input[type=text]{
	float: right;
}

.error {
    color:red;
}

</style>
</head>
<body data-ng-app="BuildingApp" data-ng-controller="buildingCTL">
	<h1>Add a building</h1>
	<div >
		<div data-ng-show="bldForm.$dirty && bldForm.$invalid">
			<span class="error" data-ng-show="bldForm.reference.$error.required">Reference is required.</span>
			<span class="error" data-ng-show="bldForm.latitude.$error.required">Latitude is required.</span>
			<span class="error" data-ng-show="bldForm.latitude.$error.pattern">Invalid latitude format.</span>
			<span class="error" data-ng-show="bldForm.longitude.$error.required">Longitude is required.</span>
			<span class="error" data-ng-show="bldForm.longitude.$error.pattern">Invalid longitude format.</span>
			<span class="error" data-ng-show="bldForm.bldName.$error.required">Name is required.</span>
			<span class="error" data-ng-show="bldForm.cPostal.$error.pattern">Invalid postal code format.</span>
			<span class="error" data-ng-show="bldForm.startDate.$error.pattern">Invalid start date format.</span>
			<span class="error" data-ng-show="bldForm.endDate.$error.pattern">Invalid end date format.</span>
		</div>
        <span class="error">{{SQLErrors}}</span>
        <span class="t">{{SQLMsgs}}</span>
		<form name="bldForm" novalidate >
			<input type="hidden" id="id" name="id" data-ng-model="bld.id" />
			<div class="section">
				<div class="field"><label for="reference"># reference * :</label><input type="text" id="reference" name="reference" data-ng-model="bld.reference" required /></div>
				<div class="field"><label for="latitude">latitude * (xx.xxxxxx):</label><input type="text" id="latitude" name="latitude" data-ng-model="bld.latitude" required data-ng-pattern="/^[0-9][0-9]\.[0-9]{6}$/" /></div>
				<div class="field"><label for="longitude">longitude * (xx.xxxxxx):</label><input type="text" id="longitude" name="longitude" data-ng-model="bld.longitude" required data-ng-pattern="/^[0-9][0-9]\.[0-9]{6}$/" /></div>
				<div class="field"><label for="bldName">Name * :</label><input type="text" id="bldName" name="bldName" data-ng-model="bld.bldName" required /></div>
				<div class="field"><label for="description">description:</label><textarea cols="38" rows="5" id="description" name="description" data-ng-model="bld.description"></textarea></div>
				<div class="field"><label for="isTemp">Is temporary?</label><input type="checkbox" id="isTemp" name="isTemp" data-ng-model="bld.isTemp"/></div>
				<div class="field"><label for="startDate">start date (dd-MM-yyyy):</label><input type="text" id="startDate" name="startDate" data-ng-model="bld.startDate" data-ng-pattern="/^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)(?:0?2|(?:Feb))\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/" /></div>
				<div class="field"><label for="endDate">end date (dd-MM-yyyy):</label><input type="text" id="endDate" name="endDate" data-ng-model="bld.endDate" data-ng-pattern="/^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)(?:0?2|(?:Feb))\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/" /></div>
			</div>
			<div class="section2">
				<div class="field"><label for="address">Address:</label><input type="text" id="address" name="address" data-ng-model="bld.address" /></div>
				<div class="field"><label for="city">City:</label><input type="text" id="city" name="city" data-ng-model="bld.city" /></div>
				<div class="field"><label for="province">province:</label><input type="text" id="province" name="province" data-ng-model="bld.province" /></div>
				<div class="field"><label for="country">country:</label><input type="text" id="country" name="country" data-ng-model="bld.country" /></div>
				<div class="field"><label for="postalCode">postal code (X5X 5X5):</label><input type="text" id="postalCode" name="postalCode" data-ng-model="bld.postalCode" data-ng-pattern="/^(?!.*[DFIOQU])[A-VXY][0-9][A-Z] [0-9][A-Z][0-9]$/" /></div>
			</div>
		</form>
		<button data-ng-click="save();" ng-disabled="bldForm.$pristine || bldForm.$invalid">Save</button>
		<button data-ng-click="delete();" ng-disabled="!canDelete">Delete</button>
        <button data-ng-click="resetFrm();" ng-disabled="bldForm.$pristine">Reset</button>
	</div>
    
	<div>
        <h1>Building List</h1>
        <span class="error" data-ng-show="lstError">{{lstError}}</span>
		<table border="1">
            <tr ><th>Reference</th><th>Name</th><th>Latitude</th><th>Longitude</th></tr>
			<tr data-ng-repeat="b in bldList" data-ng-click="loadBld(b)">
				<td>{{b.reference}}</td><td>{{b.bldName}}</td><td>{{b.latitude}}</td><td>{{b.longitude}}</td>
			</tr>
		</table>
	</div>

	<script>
    
        (function() {
        Date.prototype.toYMD = function() {
            var year, month, day;
            year = String(this.getFullYear());
            month = String(this.getMonth() + 1);
            if (month.length == 1) {
                month = "0" + month;
            }
            day = String(this.getDate());
            if (day.length == 1) {
                day = "0" + day;
            }
            return year + "-" + month + "-" + day;
        }
        })();
        (function() {
        Date.prototype.toDMY = function() {
            var year, month, day;
            year = String(this.getFullYear());
            month = String(this.getMonth() + 1);
            if (month.length == 1) {
                month = "0" + month;
            }
            day = String(this.getDate()+1); // XX: WTF +1
            if (day.length == 1) {
                day = "0" + day;
            }
            return day + "-" + month + "-" + year;
        }
        })();
        
		var app = angular.module('BuildingApp', []);
        
		app.controller('buildingCTL', function($scope, $http) {
            var ACTIVITY_DELETE = "del";
            
			$scope.bld = {id: "",
							reference :"",
							latitude:"",
							longitude:"",
							bldName:"",
							description:"",
							isTemp:false, // TODO: usefull or not? Need to be store or calculate?
							startDate:"",
							endDate:"",
							address:"",
							city:"",
							province:"",
							country:"",
							postalCode:""};
            var emptyBld = {};
            $scope.canDelete = false;
            
            $scope.bld_init = {id: "1",
							reference :"test",
							latitude:"12.123456",
							longitude:"43.123456",
							bldName:"test4",
							description:"test5",
							isTemp:true, // TODO: usefull or not? Need to be store or calculate?
							startDate:"12-12-12",
							endDate:"11-11-1900",
							address:"test9",
							city:"test10",
							province:"test11",
							country:"test12",
							postalCode:"X5X 5X5"};
			/*$scope.bld.validation = function() {
			
			}*/
            
            function init() {
                loadList();
                emptyBld = angular.copy($scope.bld);
            }
            
            $scope.loadBld = function (p_bld) {
                $scope.bld = angular.copy(p_bld);
                $scope.bld.startDate = new Date($scope.bld.startDate).toDMY();
                $scope.bld.endDate = new Date($scope.bld.endDate).toDMY();
                $scope.bldForm.$setPristine();
                $scope.canDelete = true;
            };
            
            $scope.resetFrm = function () {
                $scope.bld = angular.copy(emptyBld);
                $scope.bldForm.$setPristine();
                $scope.canDelete = false;
            };
            
            $scope.save = function () {
                if ($scope.bldForm.$dirty && $scope.bldForm.$valid) {
                    // TODO: Add validation to compare date... 
                    $http({
                        method: 'POST',
                        url: "/MESTO/MESTO_WEB_APP/php/saveBuilding.php",
                        data: {
                            id : $scope.bldForm.id.$modelValue,
							reference : $scope.bldForm.reference.$modelValue,
							latitude : $scope.bldForm.latitude.$modelValue,
							longitude : $scope.bldForm.longitude.$modelValue,
							bldName : $scope.bldForm.bldName.$modelValue,
							description : $scope.bldForm.description.$modelValue,
							isTemp : $scope.bldForm.isTemp.$modelValue,
							startDate : new Date($scope.bldForm.startDate.$modelValue).toYMD(),
							endDate : new Date($scope.bldForm.endDate.$modelValue).toYMD(),
							address : $scope.bldForm.address.$modelValue,
							city : $scope.bldForm.city.$modelValue,
							province : $scope.bldForm.province.$modelValue,
							country : $scope.bldForm.country.$modelValue,
							postalCode : $scope.bldForm.postalCode.$modelValue
                        },
                        headers : {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}
                    }).success(
                        function(data, status) {
                            if (data.msg != '') {
                                $scope.SQLMsgs = data.msg;
                                loadList();
                                $scope.resetFrm();
                            }
                            else {
                                $scope.SQLErrors = data.error;
                            }
                        }
                    ).error(
                        function(data, status, headers, config, statusText) {
                            // TODO: error server handling
                            $scope.SQLErrors = "error: "+status+":"+statusText;
                        }
                    );
                }
            };
            
            $scope.delete = function() {
                $http({
                        method: 'POST',
                        url: "/MESTO/MESTO_WEB_APP/php/saveBuilding.php",
                        data: {
                            id : $scope.bldForm.id.$modelValue,
							activity : ACTIVITY_DELETE
                        },
                        headers : {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}
                    }).success(
                        function(data, status) {
                            if (data.msg != '') {
                                $scope.SQLMsgs = data.msg;
                                loadList();
                                $scope.resetFrm();
                            }
                            else {
                                $scope.SQLErrors = data.error;
                            }
                        }
                    ).error(
                        function(data, status, headers, config, statusText) {
                            // TODO: error server handling
                            $scope.SQLErrors = "error: "+status+":"+statusText;
                        }
                    );
            };
            
            $scope.refresh = function() {
                loadList();
            };
            
            function loadList () {
                $http.post("/MESTO/MESTO_WEB_APP/php/DAOBuilding.php").success(
                    function(data) {
                        $scope.bldList = data;
                    }
                ).error(
                    function(data, status, headers, config, statusText) {
                        // TODO: error server handling
                        $scope.lstError = "error: "+status+":"+statusText;
                        //$scope.error = "error: "+data+" -- "+status+" -- "+headers+" -- "+config;
                    }
                );
            };
            
            init();
		});
	</script>
</body>
</html>