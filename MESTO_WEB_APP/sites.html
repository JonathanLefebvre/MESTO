<!DOCTYPE html>
<html>
<head>
  <title>Manage Sites</title>
  <script src="libs/angular.min.js"></script>

<style>
/* In IE vs Chrome, the column of textarea is different */
form {
	border:1px solid black;
	width:695px; 
	height:300px;
}

.section, .section2 {
    display: block;
    width: 330px;
	/*border: 1px solid red;*/
	padding: 4px;
}
.section2 {
    position: relative;
	top: -301px;
	left: 339px;
}

.field, .fieldgrp {
    display: block;
    padding: 4px 4px;
} 
.field label {
	padding-right: 5px;
}
.field input[type=text]{
	float: right;
}

.error {
    color:red;
}

</style>
</head>
<body data-ng-app="SiteApp" data-ng-controller="siteCTL">
	<h1>Add a Site</h1>
	<div >
		<div data-ng-show="siteForm.$dirty && siteForm.$invalid">
			<span class="error" data-ng-show="siteForm.reference.$error.required">Reference is required.</span>
			<span class="error" data-ng-show="siteForm.latitude.$error.required">Latitude is required.</span>
			<span class="error" data-ng-show="siteForm.latitude.$error.pattern">Invalid latitude format.</span>
			<span class="error" data-ng-show="siteForm.longitude.$error.required">Longitude is required.</span>
			<span class="error" data-ng-show="siteForm.longitude.$error.pattern">Invalid longitude format.</span>
			<span class="error" data-ng-show="siteForm.siteName.$error.required">Name is required.</span>
			<span class="error" data-ng-show="siteForm.postalCode.$error.pattern">Invalid postal code format.</span>
			<span class="error" data-ng-show="siteForm.startDate.$error.pattern">Invalid start date format.</span>
            <span class="error" data-ng-show="siteForm.endDate.$error.required">End date is required for temporary site.</span>
			<span class="error" data-ng-show="siteForm.endDate.$error.pattern">Invalid end date format.</span>
            <span class="error" data-ng-show="siteForm.endDate.$error.greaterThan">End date need to be greater than start date.</span>
		</div>
        <span class="error">{{SQLErrors}}</span>
        <span class="t">{{SQLMsgs}}</span>
		<form name="siteForm" novalidate >
			<input type="hidden" id="id" name="id" data-ng-model="site.id" />
			<div class="section">
				<div class="field"><label for="reference"># reference * :</label><input type="text" id="reference" name="reference" data-ng-model="site.reference" required /></div>
				<div class="field"><label for="latitude">latitude * (xx.xxxxxx):</label><input type="text" id="latitude" name="latitude" data-ng-model="site.latitude" required data-ng-pattern="/^[0-9][0-9]\.[0-9]{6}$/" /></div>
				<div class="field"><label for="longitude">longitude * (xx.xxxxxx):</label><input type="text" id="longitude" name="longitude" data-ng-model="site.longitude" required data-ng-pattern="/^[0-9][0-9]\.[0-9]{6}$/" /></div>
				<div class="field"><label for="siteName">Name * :</label><input type="text" id="siteName" name="siteName" data-ng-model="site.siteName" required /></div>
				<div class="field"><label for="description">description:</label><textarea cols="38" rows="5" id="description" name="description" data-ng-model="site.description"></textarea></div>
				<div class="field"><label for="isTemporary">Is temporary?</label>
                    <input type="checkbox" id="isTemporary" name="isTemporary" data-ng-checked="site.isTemporary == true" data-ng-model="site.isTemporary"/>
                </div>
				<div class="field"><label for="startDate">start date (dd-MM-yyyy):</label>
                    <input type="text" id="startDate" name="startDate" data-ng-model="site.startDate" data-ng-keyup="validEndDate()"
                        data-ng-pattern="/^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)(?:0?2|(?:Feb))\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/" />
                </div>
				<div class="field"><label for="endDate">end date (dd-MM-yyyy):</label>
                    <input type="text" id="endDate" name="endDate" data-ng-model="site.endDate" data-ng-required="site.isTemporary == true" data-ng-keyup="validEndDate()"
                        data-ng-pattern="/^(?:(?:31(\/|-|\.)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|-|\.)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/|-|\.)(?:0?2|(?:Feb))\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|-|\.)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/" />
                </div>
			</div>
			<div class="section2">
				<div class="field"><label for="address">Address:</label><input type="text" id="address" name="address" data-ng-model="site.address" /></div>
				<div class="field"><label for="city">City:</label><input type="text" id="city" name="city" data-ng-model="site.city" /></div>
				<div class="field"><label for="province">province:</label><input type="text" id="province" name="province" data-ng-model="site.province" /></div>
				<div class="field"><label for="country">country:</label><input type="text" id="country" name="country" data-ng-model="site.country" /></div>
				<div class="field"><label for="postalCode">postal code (X5X 5X5):</label><input type="text" id="postalCode" name="postalCode" data-ng-model="site.postalCode" data-ng-pattern="/^(?!.*[DFIOQU])[A-VXY][0-9][A-Z] [0-9][A-Z][0-9]$/" /></div>
                <div class="field"><label for="role">Role:</label><select id="role" ng-model="site.role" name="role" ng-options="role.value as role.label for role in ROLE"></select></div>
			</div>
		</form>
		<button data-ng-click="save();" ng-disabled="siteForm.$pristine || siteForm.$invalid">Save</button>
		<button data-ng-click="delete();" ng-disabled="!canDelete">Delete</button>
        <button data-ng-click="resetFrm();" ng-disabled="siteForm.$pristine">Reset</button>
	</div>
    
	<div>
        <h1>Sites List</h1>
        <span class="error" data-ng-show="lstError">{{lstError}}</span>
		<table border="1">
            <tr ><th>Reference</th><th>Name</th><th>Latitude</th><th>Longitude</th></tr>
			<tr data-ng-repeat="s in siteList" data-ng-click="loadSite(s)">
				<td>{{s.reference}}</td><td>{{s.siteName}}</td><td>{{s.latitude}}</td><td>{{s.longitude}}</td>
			</tr>
		</table>
	</div>

	<script>
    
        (function() {
        Date.prototype.toYMD = function() {
            var year, month, day;
            year = String(this.getFullYear());
            month = String(this.getMonth() + 1);
            if (month.length == 1) {
                month = "0" + month;
            }
            day = String(this.getDate());
            if (day.length == 1) {
                day = "0" + day;
            }
            return year + "-" + month + "-" + day;
        }
        })();
        (function() {
        Date.prototype.toDMY = function() {
            var year, month, day;
            year = String(this.getFullYear());
            month = String(this.getMonth() + 1);
            if (month.length == 1) {
                month = "0" + month;
            }
            day = String(this.getDate()+1); // XX: WTF +1
            if (day.length == 1) {
                day = "0" + day;
            }
            return day + "-" + month + "-" + year;
        }
        })();
        
		var app = angular.module('SiteApp', []);
        
		app.controller('siteCTL', function($scope, $http) {
            var ACTIVITY_DELETE = "del";
            $scope.ROLE = [{value:'ED',label:'Edifice'},{value:'FLR',label:'Floor'},{value:'FOB',label:'FOB'},{value:'COP',label:'COP'},{value:'CMP',label:'CAMP'}];
            
			$scope.site = {id: "",
							reference :"",
							latitude:"",
							longitude:"",
							siteName:"",
							description:"",
							isTemporary:false,
							startDate:"",
							endDate:"",
							address:"",
							city:"",
							province:"",
							country:"",
							postalCode:"",
                            role:""};
            var emptySite = {};
            $scope.canDelete = false;
            
            // TODO: To remove at some point
            $scope.site_init = {id: "1",
							reference :"test",
							latitude:"12.123456",
							longitude:"43.123456",
							siteName:"test4",
							description:"test5",
							isTemporary:true,
							startDate:"12-12-12",
							endDate:"11-11-1900",
							address:"test9",
							city:"test10",
							province:"test11",
							country:"test12",
							postalCode:"X5X 5X5",
                            role:"COP"};
            
            function init() {
                loadList();
                emptySite = angular.copy($scope.site);
                //$scope.site = angular.copy($scope.site_init); // TODO: to remove at some point...
            }
            
            $scope.loadSite = function(p_site) {
                $scope.site = angular.copy(p_site);
                $scope.site.startDate = new Date($scope.site.startDate).toDMY();
                $scope.site.endDate = new Date($scope.site.endDate).toDMY();
                $scope.siteForm.$setPristine();
                $scope.canDelete = true;
            };
            
            $scope.resetFrm = function() {
                $scope.site = angular.copy(emptySite);
                $scope.siteForm.$setPristine();
                $scope.canDelete = false;
                // TODO: reset old msg update a site, load again, modify and clic on reset...
            };
            
            $scope.save = function() {
                if ($scope.siteForm.$dirty && $scope.siteForm.$valid) {
                    $http({
                        method: 'POST',
                        url: "/MESTO/MESTO_WEB_APP/php/saveSite.php", // TODO: Make a config with path
                        data: {
                            id : $scope.siteForm.id.$modelValue,
							reference : $scope.siteForm.reference.$modelValue,
							latitude : $scope.siteForm.latitude.$modelValue,
							longitude : $scope.siteForm.longitude.$modelValue,
							siteName : $scope.siteForm.siteName.$modelValue,
							description : $scope.siteForm.description.$modelValue,
							isTemporary : $scope.siteForm.isTemporary.$modelValue,
							startDate : new Date($scope.siteForm.startDate.$modelValue).toYMD(), // TODO : problem with the constructor, make it custom to put real value. Date.Parse?
							endDate : new Date($scope.siteForm.endDate.$modelValue).toYMD(),
							address : $scope.siteForm.address.$modelValue,
							city : $scope.siteForm.city.$modelValue,
							province : $scope.siteForm.province.$modelValue,
							country : $scope.siteForm.country.$modelValue,
							postalCode : $scope.siteForm.postalCode.$modelValue,
                            role : $scope.siteForm.role.$modelValue
                        },
                        headers : {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}
                    }).success(
                        function(data, status) {
                            if (data.msg != '') {
                                $scope.SQLMsgs = data.msg;
                                loadList();
                                $scope.resetFrm();
                            }
                            else {
                                $scope.SQLErrors = data.error;
                            }
                        }
                    ).error(
                        function(data, status, headers, config, statusText) {
                            // TODO: error server handling
                            $scope.SQLErrors = "error: "+status+":"+statusText;
                        }
                    );
                }
            };
            
            $scope.delete = function() {
                $http({
                        method: 'POST',
                        url: "/MESTO/MESTO_WEB_APP/php/saveSite.php", // TODO: Make a config with path
                        data: {
                            id : $scope.siteForm.id.$modelValue,
							activity : ACTIVITY_DELETE
                        },
                        headers : {'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}
                    }).success(
                        function(data, status) {
                            if (data.msg != '') {
                                $scope.SQLMsgs = data.msg;
                                loadList();
                                $scope.resetFrm();
                            }
                            else {
                                $scope.SQLErrors = data.error;
                            }
                        }
                    ).error(
                        function(data, status, headers, config, statusText) {
                            // TODO: error server handling
                            $scope.SQLErrors = "error: "+status+":"+statusText;
                        }
                    );
            };
            
            $scope.refresh = function() {
                loadList();
            };
            
            $scope.validEndDate = function() {
                if ($scope.siteForm.endDate.$valid && $scope.siteForm.startDate.$valid && $scope.siteForm.endDate.$dirty && $scope.siteForm.startDate.$dirty
                        && Date.parse($scope.site.endDate) <= Date.parse($scope.site.startDate)) {
                    $scope.siteForm.endDate.$setValidity('greaterThan', false);
                }
                else {
                    $scope.siteForm.endDate.$setValidity('greaterThan', true);
                }
            };
            
            function loadList() {
                $http.post("/MESTO/MESTO_WEB_APP/php/DAOSite.php").success( // TODO: Make a config with path
                    function(data) {
                        $scope.siteList = data;
                    }
                ).error(
                    function(data, status, headers, config, statusText) {
                        // TODO: error server handling
                        $scope.lstError = "error: "+status+":"+statusText;
                        //$scope.error = "error: "+data+" -- "+status+" -- "+headers+" -- "+config;
                    }
                );
            };
            
            init();
		});
	</script>
</body>
</html>